# Система сборки CMake

Для компиляции простых программ достаточно вызывать только команду компиляции, например:
```bash
g++ main.cpp unit.cpp -o my_program 
```
Более сложные программы обычно полагаются на внешние библиотеки, наборы дополнительных файлов (файлы с данными, файлы настроек, изображения и т.д.).
Иногда такие программы компилируют частями, разбивая их на отдельные модули. 
Таким образом, процесс компиляции может включать в себя несколько запусков компилятора с различными файлами и настройками, 
с учётом расположения ранее скомпилированных частей программы, очистку папок от временных файлов, 
копирование уже готовой программы и её файлов в отдельный, от файлов исходного кода, каталог.

**Система автоматизации сборки** -- набор программ, призванных упростить компиляцию кода, с учётом параметров компилятора, 
зависимостей кода (других библиотек), выполнения модульных тестов, очистки проекта от временных файлов и т.п. 
Система сборки полагается на специальные конфигурационные файлы, которые описывают состав проекта и процесс его компиляции. 
Большинство современных IDE при компиляции программы не вызывают компилятор напрямую, а обращаются к системе сборки. 
Например Qt Creator и CLion полагаются на CMake.

**CMake** -- система сборки, которая позволяет автоматизировать компиляцию программ и их частей (сконфигурировать команды компиляции), 
выполнение тестов, развёртывание программы и т.п. Конфигурация сборки описывается в файле CMakeLists.txt

CMake используется средами разработки Qt Craetor, CLion и др.

### Основные понятия
В основе файлов конфигурации cmake лежат **цели (targets)**. Целями могут выступать например: 
- компиляция исполняемого файла (add_executable);
- компиляция библиотеки  (add_library);
- включить в текущий проект, другой cmake проект (add_subdirectory).

Для задания цели нужно указать ей тип, задать или указать название и указать основные файлы исходного кода.

Помимо задания цели можно определить название **проекта**, его описание и свойства (`project( ... )`). **Параметры** метакомпилятора (`set( var value)`  или `add_compile_options(-O2)`. CMake не привязан к конкретному компилятору, поэтому можно задавать параметры (например версию стандарта C++) в формате предусмотренным CMake.

Многие параметры задаются через специальные **переменные** командой set, например `set(CMAKE_CXX_STANDARD 20)`. Обращаться к переменным, например так: `${PROJECT_NAME}`

Если программа использует хранит файлы исходного кода или библиотеки в других папках, то указываются **дополнительные пути**, после того как задана цель компиляции:
- для исходных файлов (`target_include_directories ( ... ) `), которые передаются компилятору;
- для скомпилированных файлов библиотек (`target_link_directories ( ... )`, `target_link_libraries(...)`), которые передаются компоновщику (линковщику) [см. этапы компиляции С++ программы]

Наконец можно указать **папку для сохранения выходных файлов**: `set (CMAKE_RUNTIME_OUTPUT_DIRECTORY bin)`

Если необходимо, можно скопировать файлы из папки с исходниками в папку сборки. Например
```CMake
configure_file(data/my_data.txt ${CMAKE_CURRENT_BINARY_DIR}/bin/data/my_data.txt)
```
копирует файл `data/my_data.txt` в каталог сборки (`${CMAKE_CURRENT_BINARY_DIR}`). Если необходимо, в новом месте создаётся папка.

Рекомендуется разделять как минимум папку с файлами исходного кода и папку сборки, где будет создан, например, исполняемый файл проекта. 

## Hello, World

Рассмотрим простую программу **main.cpp**
```C++
#include <iostream>
using namespace std;

int main(){
	cout << "Hello, World\n"; }
```
Создадим простой файл конфигурации сборки `CMakeLists.txt`
```cmake
# add_executable -- цель -- создание исполняемого файла
add_executable(                         
  hello_world                       # имя выходного файла = имя проекта
  main.cpp                          # Список файлов исходного кода
)
```

**Сборка**

Структура проекта:
```
my_project
   |-- src
   |   |-- main.cpp
   |   |-- CMakeLists.txt
```

Подготовка сборки, временные файлы сборки и исполняемый файл будут сохранены в папку build, находящуюся на одном уровне с папкой src
```bash
cmake -B ../my_build .
```
- `../my_build` путь из папки с файлом CMakeLists.txt к папке, где будет происходить сборка

Сборка:
```bash
cmake --build ../my_build 
```

В результате получится структура проекта
```
my_project
   |-- src
   |   |-- main.cpp
   |   |--CMakeLists.txt
   |-- my_build
   |   |-- ...служебные файлы и папки ...
   |   |-- my_project.exe
```


## Расширенный пример
Более сложный файл конфигурации сборки `CMakeLists.txt`
```cmake
cmake_minimum_required(VERSION 3.24)			# требуемая версия CMake

# название проекта my_project и его версия
project(my_project VERSION 1.5)

# настроки компилятора
# set(CMAKE_CXX_COMPILER "g++-12")         		# имя компилятора (можно указать полный путь)
set(CMAKE_CXX_STANDARD 20)               		# версия стандарта языка
# set(CMAKE_CXX_STANDARD_REQUIRED True)  		# включает проверку: задана ли явно версия стандарта языка
add_compile_options(-O2)                 		# другие опции компиляции: второй уровень потимизации кода


# папка для сохранения исполняемого файла: bin
# стоит указать, чтобы отделить от служебных файлов генерируемых CMake
set (CMAKE_RUNTIME_OUTPUT_DIRECTORY bin)

# add_executable -- цель -- создание исполняемого файла
add_executable(                         
  ${PROJECT_NAME}                        # имя файла = имя проекта
  main.cpp                               # Список файлов исходного кода через пробел
)


# если нужно: дополнительная папка для поиска файлов исходного кода (cpp и h) 
# должна быть указана после того, как указана цель сборки add_executable или add_librarie
# target_include_directories(${PROJECT_NAME} PUBLIC include)
# Второй аргумент задёт видимость включаемых файлов для проектов, использующих данный (если они есть)
```


В результате получится структура проекта
```
my_project
   |-- src
   |   |-- main.cpp
   |   |--CMakeLists.txt
   |-- my_build
   |   |-- ...служебные файлы и папки ...
   |   |-- my_project.exe
   |   |-- bin
   |   |   |-- my_project.exe
```


## См. также
Папки с примерами в этом каталоге

# Ссылки
- https://cliutils.gitlab.io/modern-cmake/
