# Языку препроцессора C 

Препроцессинг — это этап компиляции, выполняющий подготовку к компиляции исходного кода: обработку директив `#include`, `#define`, условий компиляции и др. На этом этап не происходит синтаксическая анализа кода на языке С, только происходит работа *с текстом программы*.

См. также *этапы компиляции программы* на языке С.

## Основные директивы препроцессора

#### `#include` — включение заголовочных файлов
Вставляет текст (содержимое) файла с исходным кодом.

```c
#include <stdio.h>   // системный заголовок
#include "myfile.h"  // пользовательский файл
```

* `<...>` — ищет в системных путях.
* `"..."` — сначала ищет в текущем каталоге, затем как `<...>`.

#### `#define` — определение макросов

Макрос в языке С — это правило для текстовой подстановки, которое задаётся директивой препроцессора 

```c
// объявление "константы". Везде где в программе будет встречен идентификатор макроса PI будет подставлено значение 3.14159
#define PI 3.14159

// Объявление "функции"
#define SQUARE(x) ((x)*(x))
```

Если не поставить скобки в "функции", то может быть нарушен приоритет операций. 

Например
```c
#define SQUARE(x) x*x
// SQUARE(1+2)  -> 1+2 * 1+2
```

* Макросы **не имеют типов**.
* Макросы с аргументами не проверяют типы или порядок вычислений. Поэтому макросы могут привести к ошибкам, которые не всегда легко заметить сразу.

См. также ключевое слово языка С - `inline`.

#### `#undef` — удаление макроса

```c
#undef PI
```

#### `#ifdef`, `#ifndef`, `#if`, `#else`, `#elif`, `#endif` — условная компиляция

```c
#ifdef DEBUG
    printf("Debug mode\n");
#endif

#if VERSION >= 2
    // ...
#else
    // ...
#endif
```

* В `#if`, `#elif` можно использовать **числовые выражения**.
* Только **константные выражения** (никаких вызовов функций).

#### `#error`, `#warning` (C23)

```c
#error "Unsupported compiler version"
#warning "This feature is experimental"
```

* `#error` — вызывает ошибку компиляции.
* `#warning` — директива **C23**, вызывает предупреждение.

---

### 2. Операторы макроподстановки

#### `#` — превращение аргумента в строку

```c
#define TO_STRING(x) #x
TO_STRING(123) // → "123"
```

#### `##` — конкатенация токенов

```c
#define MAKE_VAR(name, num) name##num
int MAKE_VAR(var, 1); // → int var1;
```

---


### Специальные макросы

| Макрос             | Значение                                 |
| ------------------ | ---------------------------------------- |
| `__FILE__`         | Имя текущего файла в виде строки         |
| `__LINE__`         | Номер строки в текущем файле             |
| `__DATE__`         | Дата компиляции: `"Mmm dd yyyy"`         |
| `__TIME__`         | Время компиляции: `"hh:mm:ss"`           |
| `__STDC__`         | Равен `1`, если соблюдается стандарт ISO |
| `__STDC_VERSION__` | Например: `202311L` для C23              |


### Макросы для обеспечения кроссплатформенности
```c
#if defined(_WIN32) || defined(_WIN64)
// Код для Windows
#elif defined(__linux__)
// Код для Linux
#elif defined(__APPLE__)
// Код для macOS/iOS
#else
#error "Неизвестная платформа"
#endif
```

### Советы по использованию
* Используйте #define только когда действительно нет альтернативы.
* Используйте inline, const, enum вместо #define
* Обертывайте аргументы макросов в скобки: `((x)+(y))`.
* Используйте `#pragma` для нестандартных указаний компилятору (зависит от реализации).
* Для организации кода применяйте защиту от двойного включения:

```c
#ifndef MYHEADER_H
#define MYHEADER_H

// содержимое заголовка

#endif
```


### Отладка макросов

Современные компиляторы (gcc, clang, MSVC) позволяют:

* Печать промежуточного кода после препроцессора:

```bash
gcc -E file.c -o out.i
```

## Разное
Объявление макросов может использоваться для включение или выключения возможностей:

Включить поддержку нестандартных математических констант M_PI, M_E, M_SQRT2 и др.
```с
#define _USE_MATH_DEFINES
#include <math.h> // или <cmath> в C++
```

Отключает MSVC‑предупреждения о scanf, strcpy
```c
#define _CRT_SECURE_NO_WARNINGS
```